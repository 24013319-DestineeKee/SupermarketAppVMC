<%- include('partials/header', {
  title: 'Refund Request Dashboard',
  user,
  navLinks: [
    { href: '/orders', label: 'Orders' },
    { href: '/refunds', label: 'Refunds' },
    { href: '/inventory', label: 'Inventory' },
    { href: '/profile', label: 'Profile' },
    { href: '/logout', label: 'Logout' }
  ]
}) %>

<style>
  .page-shell { max-width: 1100px; margin: 32px auto 48px; padding: 0 16px; }
  .card { border-radius: 16px; border: 1px solid #e5e7eb; box-shadow: 0 10px 26px rgba(16,24,40,0.06); }
  .pill { display: inline-block; padding: 4px 10px; border-radius: 999px; font-size: 12px; font-weight: 600; }
  .pill-pending { background: #fff7ed; color: #9a3412; border: 1px solid #fed7aa; }
  .pill-approved { background: #ecfeff; color: #0e7490; border: 1px solid #a5f3fc; }
  .pill-rejected { background: #fef2f2; color: #991b1b; border: 1px solid #fecdd3; }
</style>

<div class="page-shell">
  <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
    <div>
      <h2 class="mb-0">Refund Request Dashboard</h2>
      <p class="text-muted mb-0">Review user refund requests and approve partial/full refunds.</p>
    </div>
    <a href="/refunds" class="btn btn-outline-primary btn-sm">Refresh</a>
  </div>

  <% if (messages && messages.error && messages.error.length) { %>
    <div class="alert alert-danger">
      <% messages.error.forEach(function(msg){ %><div><%= msg %></div><% }); %>
    </div>
  <% } %>
  <% if (messages && messages.success && messages.success.length) { %>
    <div class="alert alert-success">
      <% messages.success.forEach(function(msg){ %><div><%= msg %></div><% }); %>
    </div>
  <% } %>

  <% if (!reports || !reports.length) { %>
    <div class="alert alert-secondary">No refund reports yet.</div>
  <% } else { %>
    <div class="card">
      <div class="table-responsive">
        <table class="table table-striped mb-0 align-middle">
          <thead class="table-light">
            <tr>
              <th>ID</th>
              <th>Order</th>
              <th>User</th>
              <th>Reason</th>
              <th>Evidence</th>
              <th>Type</th>
              <th>Status</th>
              <th>Details</th>
            </tr>
          </thead>
          <tbody>
            <% reports.forEach(function(report){ %>
              <tr>
                <td>#<%= report.id %></td>
                <td>
                  <div>Order #<%= report.orderId %></div>
                  <div class="small text-muted">Total: $<%= Number(report.orderTotal || 0).toFixed(2) %></div>
                </td>
                <td>
                  <div><%= report.username || ('User #' + report.userId) %></div>
                  <div class="small text-muted"><%= report.email || '' %></div>
                </td>
                <td>
                  <div class="fw-semibold"><%= report.reason %></div>
                  <div class="small text-muted"><%= report.description || '' %></div>
                </td>
                <td>
                  <% if (report.image) { %>
                    <img src="/reports/<%= report.image %>" alt="evidence" style="width: 72px; height: 72px; object-fit: cover;" loading="lazy">
                  <% } else { %>
                    <span class="text-muted">None</span>
                  <% } %>
                </td>
                <td>
                  <% if (report.supportType === 'partial_refund') { %>
                    <span class="pill pill-pending">Partial refund</span>
                  <% } else { %>
                    <span class="pill pill-approved">Full refund</span>
                  <% } %>
                </td>
                <td>
                  <% const status = (report.status || 'pending'); %>
                  <% if (status === 'pending') { %>
                    <a class="pill pill-pending text-decoration-none" href="/refunds/<%= report.id %>">Pending</a>
                  <% } else if (status.startsWith('approved')) { %>
                    <span class="pill pill-approved"><%= status.replace('approved_', 'approved ') %></span>
                  <% } else { %>
                    <span class="pill pill-rejected">Rejected</span>
                  <% } %>
                  <% if (report.refundAmount && Number(report.refundAmount) > 0) { %>
                    <div class="small text-muted">Refund: $<%= Number(report.refundAmount).toFixed(2) %></div>
                  <% } %>
                  <% if (report.resolutionNote) { %>
                    <div class="small text-muted">Note: <%= report.resolutionNote %></div>
                  <% } %>
                </td>
                <td>
                  <a class="btn btn-outline-primary btn-sm" href="/refunds/<%= report.id %>">View</a>
                </td>
              </tr>
            <% }); %>
          </tbody>
        </table>
      </div>
    </div>
  <% } %>
</div>

<%- include('partials/footer') %>

<%- include('partials/header', {
  title: 'NETS QR Payment',
  user,
  navLinks: [
    { href: '/cart', label: 'Back to Cart' },
    { href: '/shopping', label: 'Shopping' },
    { href: '/logout', label: 'Logout' }
  ]
}) %>

<style>
  .qr-shell { max-width: 720px; margin: 32px auto 48px; padding: 0 16px; }
  .qr-card { background: #ffffff; border: 1px solid #e5e7eb; border-radius: 16px; box-shadow: 0 12px 32px rgba(16,24,40,0.08); padding: 24px; }
  .qr-img { width: 260px; height: 260px; object-fit: contain; border: 1px solid #e5e7eb; border-radius: 12px; }
  .pill { display: inline-block; padding: 6px 12px; border-radius: 999px; font-size: 0.85rem; }
  .pill-success { background: #e6fffa; color: #0f766e; border: 1px solid #99f6e4; }
</style>

<div class="qr-shell">
  <div class="qr-card">
    <div class="d-flex justify-content-between align-items-start flex-wrap gap-2 mb-3">
      <div>
        <h3 class="mb-1">Scan to Pay with NETS</h3>
        <div class="text-muted">Amount: S$<%= total %></div>
      </div>
      <div class="pill pill-success">NETS QR</div>
    </div>

    <% if (timer) { %>
      <div class="alert alert-warning py-2 mb-3">
        This QR expires in <span id="countdown"><%= timer %></span> seconds. Refresh to generate a new code after expiry.
      </div>
    <% } %>

    <div class="text-center my-4">
      <img class="qr-img" src="<%= qrCodeUrl %>" alt="NETS QR code">
      <div class="mt-3 small text-muted">Txn Ref: <strong><%= txnRetrievalRef %></strong></div>
      <% if (courseInitId) { %><div class="small text-muted">Course Init ID: <%= courseInitId %></div><% } %>
    </div>

    <div class="border-top pt-3">
      <h6>What to do:</h6>
      <ol class="ps-3 mb-3">
        <li>Open your mobile banking app that supports NETS QR.</li>
        <li>Scan the QR code above and confirm the payment of S$<%= total %>.</li>
        <li>After your payment appears as successful, please wait for confirmation.</li>
        <li>If it expires, refresh to generate a new code.</li>
      </ol>
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
        <a class="btn btn-outline-secondary" href="/cart">Back to cart</a>
      </div>
    </div>
  </div>
</div>

<script>
  (() => {
    const el = document.getElementById('countdown');
    if (!el) return;
    let remaining = parseInt(el.textContent, 10);
    const tick = () => {
      remaining -= 1;
      if (remaining <= 0) {
        el.textContent = '0';
        window.location.href = '/nets/qr/fail?reason=timeout';
        return;
      }
      el.textContent = remaining.toString();
      setTimeout(tick, 1000);
    };
    setTimeout(tick, 1000);

    const pollStatus = async () => {
      try {
        const res = await fetch('/nets/confirm', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', Accept: 'application/json' }
        });
        const data = await res.json().catch(() => ({}));
        if (data.status === 'pending') {
          return;
        }
        if (!res.ok || data.ok === false) {
          window.location.href = data.redirect || '/checkout';
          return;
        }
        window.location.href = data.redirect || `/invoice/${data.orderId}`;
      } catch (err) {
        // silent retry
      }
    };

    setInterval(pollStatus, 4000);
  })();
</script>

<%- include('partials/footer') %>


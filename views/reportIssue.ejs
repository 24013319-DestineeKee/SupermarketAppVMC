<%- include('partials/header', {
  title: 'Report an Issue',
  user,
  navLinks: [
    { href: '/my-orders', label: 'My Orders' },
    { href: '/shopping', label: 'Shopping' },
    { href: '/cart', label: 'Cart' },
    { href: '/logout', label: 'Logout' }
  ]
}) %>

<div class="container" style="max-width: 760px; margin-top: 32px; margin-bottom: 48px;">
  <h2 class="mb-3">Ask for a Refund for Order #<%= order.id %></h2>
  <% if (messages && messages.error && messages.error.length) { %>
    <div class="alert alert-danger">
      <% messages.error.forEach(function(msg){ %><div><%= msg %></div><% }); %>
    </div>
  <% } %>
  <% if (messages && messages.success && messages.success.length) { %>
    <div class="alert alert-success">
      <% messages.success.forEach(function(msg){ %><div><%= msg %></div><% }); %>
    </div>
  <% } %>

  <% if (report) { %>
    <div class="alert alert-info">
      You already submitted a report for this order. Current status:
      <strong><%= report.status %></strong>
      <% if (report.refundAmount) { %> â€” Refund: $<%= Number(report.refundAmount).toFixed(2) %><% } %>
    </div>
  <% } %>

  <form action="/orders/<%= order.id %>/report" method="POST" enctype="multipart/form-data" class="card p-4 shadow-sm">
    <div class="mb-3">
      <label class="form-label" for="reasonSelect">Issue summary</label>
      <select id="reasonSelect" name="reason" class="form-select" required>
        <option value="" selected disabled>Select a reason</option>
        <option value="Damaged items">Damaged items</option>
        <option value="Missing items">Missing items</option>
        <option value="Wrong items">Wrong items</option>
        <option value="Late delivery">Late delivery</option>
        <option value="Quality issue">Quality issue</option>
        <option value="Other">Other</option>
      </select>
    </div>
    <div class="mb-3 d-none" id="reasonOtherWrap">
      <label class="form-label" for="reasonOther">Other reason</label>
      <input type="text" id="reasonOther" name="reasonOther" class="form-control" placeholder="Describe your reason">
    </div>
    <div class="mb-3">
      <label class="form-label">Details</label>
      <textarea name="description" class="form-control" rows="4" placeholder="Describe what went wrong and which items were affected." required></textarea>
    </div>
    <div class="mb-3">
      <label class="form-label">Upload evidence (image)</label>
      <input type="file" name="evidence" accept="image/*" class="form-control">
      <div class="form-text">Optional but recommended: photo of the package/damaged items.</div>
    </div>
    <button type="submit" class="btn btn-primary">Ask for refund</button>
    <a class="btn btn-link" href="/my-orders">Back to orders</a>
  </form>
</div>

<script>
  (() => {
    const select = document.getElementById('reasonSelect');
    const otherWrap = document.getElementById('reasonOtherWrap');
    const otherInput = document.getElementById('reasonOther');
    const toggleOther = () => {
      const isOther = select && select.value === 'Other';
      if (otherWrap) otherWrap.classList.toggle('d-none', !isOther);
      if (otherInput) otherInput.required = !!isOther;
    };
    if (select) {
      select.addEventListener('change', toggleOther);
      toggleOther();
    }
  })();
</script>

<%- include('partials/footer') %>
